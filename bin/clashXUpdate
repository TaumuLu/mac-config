#!/usr/bin/env node --no-warnings
const { parse, stringify } = require("yaml")
const fs = require('fs')

const subUrl = process.env.CLASHX_SUB
const myConfigPath = `${process.env.HOME}/Library/Mobile Documents/iCloud~com~west2online~ClashX/Documents/mt.yaml`

if (!fs.existsSync(myConfigPath)) {
  throw new Error(`not found myConfig: ${myConfigPath}`)
}

if (subUrl) {
  console.log('--------', `åŠ è½½è¿œç¨‹é…ç½®ï¼š\n${subUrl}`)

  fetch(subUrl).then((res) => res.text()).then((res) => {
    const myConfigFile = fs.readFileSync(myConfigPath, 'utf8')
    const myConfig = parse(myConfigFile)
    const config = parse(res)

    Object.keys(myConfig).forEach((key) => {
      const myValue = myConfig[key]
      const value = config[key]
      switch (key) {
        // è·³è¿‡é…ç½®
        case 'rules':
          break
        case 'proxy-groups':
          const nodeSelect = value.find((item) => item.name === 'ğŸ”° èŠ‚ç‚¹é€‰æ‹©')
          if (nodeSelect) {
            console.log('--------', `åŒæ­¥ï¼š'ğŸ”° èŠ‚ç‚¹é€‰æ‹©'`)
            myValue[0].proxies = nodeSelect.proxies
          }
          const autoSelect = value.find((item) => item.name === 'â™»ï¸ è‡ªåŠ¨é€‰æ‹©')
          if (autoSelect) {
            console.log('--------', `åŒæ­¥ï¼š'â™»ï¸ è‡ªåŠ¨é€‰æ‹©'`)
            myValue[1].proxies = autoSelect.proxies
          }
          break;
        default:
          if (value) {
            console.log('--------', `åŒæ­¥é…ç½®ï¼š${key}`)
            myConfig[key] = value
          }
          break;
      }
    })

    // å†™å…¥åŸæ–‡ä»¶
    const newConfig = stringify(myConfig)
    fs.writeFileSync(myConfigPath, newConfig)
    console.log('--------', `è§£æå®Œæˆï¼Œè¯·é‡æ–°åŠ è½½é…ç½®`)
  })
} else {
  throw new Error(`not found clashX config url: ${subUrl}`)
}
